{% extends 'base.html' %}
{% load static %}

{% block title %}Inventario{% endblock %}

{% block content %}
<body data-allow-tag-create="{% if request.user.rol in 'admin,encargado' %}true{% else %}false{% endif %}">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
<div class="container py-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h2>Inventario de Componentes</h2>
    </div>

    {% if messages %}
        <div class="container mt-3">
            {% for message in messages %}
                <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Cerrar"></button>
                </div>
            {% endfor %}
        </div>
    {% endif %}

    <form method="get" class="mb-4">
        <div class="input-group">
            <input type="text" name="q" value="{{ query }}" class="form-control" placeholder="Buscar por código o descripción">
            <button class="btn btn-outline-primary" type="submit">Buscar</button>
        </div>

        <div class="mt-3">
            <!-- Botón para mostrar filtros -->
            <button class="btn btn-outline-secondary mb-2" type="button" data-bs-toggle="collapse" data-bs-target="#filterBox">
                <i class="bi bi-filter"></i> Categorías
            </button>

            <!-- Input de búsqueda de categorías -->
            <div class="collapse" id="filterBox">
                <input type="text" id="tagInput" class="form-control mb-2" placeholder="Buscar categoría...">
                <div id="tagSuggestions" class="list-group"></div>
            </div>

            <!-- Checkboxes invisibles para enviar los tags seleccionados -->
            <div id="hiddenTags">
                {% for tag in selected_tags %}
                    <input type="hidden" name="tags" value="{{ tag }}">
                {% endfor %}
            </div>

            <!-- Badges de filtros activos con botón para eliminar -->
            <div id="selectedTags" class="mt-2">
                {% for tag in selected_tags %}
                    <span class="badge bg-primary me-1">
                        {{ tag }}
                        <a href="#" class="text-white ms-1 text-decoration-none" onclick="removeTag('{{ tag }}')">&times;</a>
                    </span>
                {% endfor %}
            </div>
        </div>
    </form>

    <form method="post" action="{% url 'inventory:bulk_delete' %}">
        {% csrf_token %}
        <div class="row row-cols-1 row-cols-md-3 g-4">
            {% for component in components %}
                <div class="col">
                    <div class="card h-100" onclick="mostrarDetalleComponente({{ component.id }}, event)" style="cursor: pointer;">
                        {% if component.image and component.image.thumbnail %}
                            <img src="{{ component.image.thumbnail.url }}" class="card-img-top" alt="{{ component.code }}">
                        {% else %}
                            <img src="{% static 'img/no-image.png' %}" class="card-img-top" alt="Sin imagen">
                        {% endif %}
                        <div class="card-body">
                            <h5 class="card-title">{{ component.code }}</h5>
                            <p class="card-text">
                                <strong>Descripcion:</strong> {{ component.description }}<br>
                                <strong>Stock:</strong> {{ component.stock }}<br>
                                <strong>Ubicación:</strong> {{ component.location }}
                            </p>
                            {% if request.user.rol == 'encargado' or request.user.is_staff %}
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="selected" value="{{ component.id }}">
                                    <label class="form-check-label">Seleccionar</label>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            {% empty %}
                <div class="container text-center py-5">
                    <i class="bi bi-box-seam fs-1 text-muted"></i>
                    <p class="mt-3 fs-5 text-muted">No se encontraron componentes.</p>
                </div>
            {% endfor %}
        </div>

        {% if request.user.rol == 'encargado' or request.user.is_staff %}
            <a href="{% url 'inventory:create' %}" class="btn btn-primary rounded-circle position-fixed bottom-0 end-0 m-4 shadow d-flex justify-content-center align-items-center" style="width: 56px; height: 56px;">
                <i class="bi bi-plus-lg fs-4"></i>
            </a>
            <hr class="my-4">
            <div class="mt-4 d-flex justify-content-start">
                <button type="button" id="deleteTrigger" class="btn btn-outline-danger me-3">
                    <i class="bi bi-trash"></i>
                </button>
            </div>
        {% endif %}
    </form>

    <!-- Modal de confirmación -->
    <div class="modal fade" id="confirmDeleteModal" tabindex="-1" aria-labelledby="confirmDeleteLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <form method="post" action="{% url 'inventory:bulk_delete' %}">
                    {% csrf_token %}
                    <div class="modal-header">
                        <h5 class="modal-title" id="confirmDeleteLabel">Confirmar eliminación</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                    </div>
                    <div class="modal-body">
                        <p>¿Estás seguro de que querés eliminar los componentes seleccionados?</p>
                        <input type="password" name="clave_confirmacion" class="form-control" placeholder="Ingresa tu clave" required>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-danger">Eliminar</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="modal fade" id="componentDetailModal" tabindex="-1" aria-labelledby="componentDetailLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="componentDetailLabel">Detalle del componente</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                </div>
                <div class="modal-body">
                    <div id="componentDetailContent" class="text-start">
                        <!-- Aquí se insertará el contenido dinámico -->
                    </div>
                </div>
            </div>
        </div>
    </div>


    <nav class="mt-4">
        <ul class="pagination justify-content-center">
            {% if components.has_previous %}
                <li class="page-item"><a class="page-link" href="?q={{ query }}&page={{ components.previous_page_number }}">Anterior</a></li>
            {% endif %}
            <li class="page-item active"><span class="page-link">{{ components.number }}</span></li>
            {% if components.has_next %}
                <li class="page-item"><a class="page-link" href="?q={{ query }}&page={{ components.next_page_number }}">Siguiente</a></li>
            {% endif %}
        </ul>
    </nav>
</div>

<script src="{% static 'js/deleteModal.js' %}"></script>

{{ all_tags_json|json_script:"tag-list" }}

<script src="{% static 'js/tagSelector.js' %}"></script>

<script src="{% static 'js/componentDetail.js' %}"></script>

</body>
{% endblock %}
