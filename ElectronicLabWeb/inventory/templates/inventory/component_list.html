{% extends 'base.html' %}
{% load static %}

{% block title %}Inventario{% endblock %}

{% block content %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
<div class="container py-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h2>Inventario de Componentes</h2>
    </div>

    <form method="get" class="mb-4">
        <div class="input-group">
            <input type="text" name="q" value="{{ query }}" class="form-control" placeholder="Buscar por código o descripción">
            <button class="btn btn-outline-primary" type="submit">Buscar</button>
        </div>

        <div class="mt-3">
            <!-- Botón para mostrar filtros -->
            <button class="btn btn-outline-secondary mb-2" type="button" data-bs-toggle="collapse" data-bs-target="#filterBox">
                <i class="bi bi-filter"></i> Categorías
            </button>

            <!-- Input de búsqueda de categorías -->
            <div class="collapse" id="filterBox">
                <input type="text" id="tagInput" class="form-control mb-2" placeholder="Buscar categoría...">
                <div id="tagSuggestions" class="list-group"></div>
            </div>

            <!-- Checkboxes invisibles para enviar los tags seleccionados -->
            <div id="hiddenTags">
                {% for tag in selected_tags %}
                    <input type="hidden" name="tags" value="{{ tag }}">
                {% endfor %}
            </div>

            <!-- Badges de filtros activos con botón para eliminar -->
            <div id="selectedTags" class="mt-2">
                {% for tag in selected_tags %}
                    <span class="badge bg-primary me-1">
                        {{ tag }}
                        <a href="#" class="text-white ms-1 text-decoration-none" onclick="removeTag('{{ tag }}')">&times;</a>
                    </span>
                {% endfor %}
            </div>
        </div>
    </form>

    <form method="post" action="{% url 'inventory:bulk_delete' %}">
        {% csrf_token %}
        <div class="row row-cols-1 row-cols-md-3 g-4">
            {% for component in components %}
                <div class="col">
                    <div class="card h-100">
                        {% if component.image and component.image.thumbnail %}
                            <img src="{{ component.image.thumbnail.url }}" class="card-img-top" alt="{{ component.code }}">
                        {% else %}
                            <img src="{% static 'img/no-image.png' %}" class="card-img-top" alt="Sin imagen">
                        {% endif %}
                        <div class="card-body">
                            <h5 class="card-title">{{ component.code }}</h5>
                            <p class="card-text">
                                <strong>Stock:</strong> {{ component.stock }}<br>
                                <strong>Ubicación:</strong> {{ component.location }}
                            </p>
                            {% if request.user.rol == 'encargado' or request.user.is_staff %}
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="selected" value="{{ component.id }}">
                                    <label class="form-check-label">Seleccionar</label>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            {% empty %}
                <div class="text-center py-5">
                    <i class="bi bi-box-seam fs-1 text-muted"></i>
                    <p class="mt-3 fs-5 text-muted">No se encontraron componentes.</p>
                </div>
            {% endfor %}
        </div>

        {% if request.user.rol == 'encargado' or request.user.is_staff %}
            <a href="{% url 'inventory:create' %}" class="btn btn-primary rounded-circle position-fixed bottom-0 end-0 m-4 shadow d-flex justify-content-center align-items-center" style="width: 56px; height: 56px;">
                <i class="bi bi-plus-lg fs-4"></i>
            </a>
            <hr class="my-4">
            <div class="mt-4 d-flex justify-content-start">
                <button type="submit" class="btn btn-outline-danger me-3">
                    <i class="bi bi-trash"></i>
                </button>
            </div>
        {% endif %}
    </form>

    <nav class="mt-4">
        <ul class="pagination justify-content-center">
            {% if components.has_previous %}
                <li class="page-item"><a class="page-link" href="?q={{ query }}&page={{ components.previous_page_number }}">Anterior</a></li>
            {% endif %}
            <li class="page-item active"><span class="page-link">{{ components.number }}</span></li>
            {% if components.has_next %}
                <li class="page-item"><a class="page-link" href="?q={{ query }}&page={{ components.next_page_number }}">Siguiente</a></li>
            {% endif %}
        </ul>
    </nav>
</div>

<script>
    function confirmDelete() {
        const clave = prompt("Confirma tu clave para eliminar:");
        if (!clave) return false;

        const input = document.createElement("input");
        input.type = "hidden";
        input.name = "clave_confirmacion";
        input.value = clave;
        document.forms[0].appendChild(input);
        return true;
    }
</script>

{{ all_tags_json|json_script:"tag-list" }}

<script>
    const allTags = JSON.parse(document.getElementById("tag-list").textContent);
    const input = document.getElementById("tagInput");
    const suggestions = document.getElementById("tagSuggestions");
    const selectedTags = document.getElementById("selectedTags");
    const hiddenTags = document.getElementById("hiddenTags");

    input.addEventListener("input", () => {
        const query = input.value.toLowerCase();
        suggestions.innerHTML = "";
        if (!query) return;

        const matches = allTags.filter(tag => tag.name.toLowerCase().includes(query));
        matches.forEach(tag => {
            const item = document.createElement("button");
            item.className = "list-group-item list-group-item-action";
            item.textContent = tag.name;
            item.onclick = (e) => {
                e.preventDefault();
                addTag(tag.name);
                input.value = "";
                suggestions.innerHTML = "";
            };
            suggestions.appendChild(item);
        });
    });

    function addTag(tagName) {
        if (document.querySelector(`input[value="${tagName}"]`)) return;

        const badge = document.createElement("span");
        badge.className = "badge bg-primary me-1";
        badge.innerHTML = `${tagName} <a href="#" class="text-white ms-1 text-decoration-none" onclick="removeTag('${tagName}')">&times;</a>`;
        selectedTags.appendChild(badge);

        const hiddenInput = document.createElement("input");
        hiddenInput.type = "hidden";
        hiddenInput.name = "tags";
        hiddenInput.value = tagName;
        hiddenTags.appendChild(hiddenInput);
    }

    function removeTag(tagName) {
        document.querySelectorAll(`input[value="${tagName}"]`).forEach(el => el.remove());
        document.querySelectorAll(`#selectedTags span`).forEach(span => {
            if (span.textContent.includes(tagName)) span.remove();
        });
    }
</script>

{% endblock %}
