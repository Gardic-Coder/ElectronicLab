{% extends 'base.html' %}
{% load static %}

{% block title %}Mi perfil{% endblock %}

{% block content %}
<div class="container py-4">
  <div class="mx-auto" style="max-width: 600px;">
    <h2 class="mb-4 text-center">Perfil de usuario</h2>
    <div class="text-center mb-3">
      {% if usuario.photo and usuario.photo.preview %}
        <img src="{{ usuario.photo.preview.url }}" class="perfil-circular" alt="Foto de perfil">
        <!--<img src="{{ usuario.photo.preview.url }}" class="rounded-circle img-thumbnail" style="width: 150px;" alt="Foto de perfil">-->
      {% else %}
        <img src="{% static 'img/default-user.png' %}" class="rounded-circle img-thumbnail" style="width: 150px;" alt="Sin foto">
      {% endif %}
    </div>
    <ul class="list-group">
      <li class="list-group-item"><strong>Nombre:</strong> {{ usuario.get_full_name }}</li>
      <li class="list-group-item"><strong>Cédula:</strong> {{ usuario.cedula }}</li>
      <li class="list-group-item">
        <strong>Correo:</strong>
        <div class="text-break">{{ usuario.email }}</div>
      </li>
      <li class="list-group-item"><strong>Teléfono:</strong> {{ usuario.telefono|default:"No registrado" }}</li>
      <li class="list-group-item"><strong>Rol:</strong> {{ usuario.get_rol_display }}</li>
      <li class="list-group-item"><strong>Estado:</strong> {{ usuario.get_estado_display }}</li>
    </ul>
    <div class="text-center mt-4">
      <a href="{% url 'profile-edit' %}" class="btn btn-outline-primary">Editar perfil</a>
    </div>
    <div class="text-center mt-2">
      <button type="button" class="btn btn-outline-danger" data-bs-toggle="modal" data-bs-target="#changePasswordModal">
        Cambiar contraseña
      </button>
    </div>
    {% if messages %}
        <div class="container mt-3">
            {% for message in messages %}
                <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Cerrar"></button>
                </div>
            {% endfor %}
        </div>
    {% endif %}
  </div>
</div>
<div class="modal fade" id="changePasswordModal" tabindex="-1" aria-labelledby="changePasswordLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <form method="post" action="{% url 'change-password' %}" id="changePasswordForm">
        {% csrf_token %}
        <div class="modal-header">
          <h5 class="modal-title" id="changePasswordLabel">Cambiar contraseña</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label for="current_password" class="form-label">Contraseña actual</label>
            <input type="password" name="current_password" class="form-control" required>
          </div>
          <div class="mb-3">
            <label for="new_password" class="form-label">Nueva contraseña</label>
            <input type="password" name="new_password" class="form-control" required>
          </div>
          <div class="mb-3">
            <label for="confirm_password" class="form-label">Confirmar nueva contraseña</label>
            <input type="password" name="confirm_password" class="form-control" required>
          </div>
          <div id="passwordError" class="text-danger small"></div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="submit" class="btn btn-primary">Guardar</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
document.getElementById('changePasswordForm').addEventListener('submit', function(e) {
  const current = this.current_password.value;
  const newPass = this.new_password.value;
  const confirm = this.confirm_password.value;
  const errorBox = document.getElementById('passwordError');
  errorBox.textContent = '';

  if (newPass === current) {
    e.preventDefault();
    errorBox.textContent = 'La nueva contraseña no puede ser igual a la actual.';
  } else if (newPass !== confirm) {
    e.preventDefault();
    errorBox.textContent = 'La confirmación no coincide con la nueva contraseña.';
  }
});
</script>
{% endblock %}